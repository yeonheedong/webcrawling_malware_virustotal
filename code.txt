import re
import requests
from bs4 import BeautifulSoup
import json
from elasticsearch import Elasticsearch
es= Elasticsearch()
es.indices.create(index='vvv',body='')

headers = {
    "Accept-Encoding": "gzip, deflate",
    "User-Agent": "gzip,  My Python requests library example client or username"
}

url = "http://news1.kr/articles/?3488307"
html = requests.get(url).text
soup = BeautifulSoup(html ,"html.parser")
adbox=soup.find("div",{"class":"ad_wing_l"})

for src in adbox.select('div.wingLeftBlock a[href]'):
    adurl=src['href']
    params = {'apikey': '1cfba73f4664a297c8c16a3a358fad56b0c4997a0ccf06dad74a44cca3ba4d11', 'resource': adurl}
    response = requests.post('https://www.virustotal.com/vtapi/v2/url/report', params=params, headers=headers)
    json_response = response.json()
    j = json_response
    
    if(j['response_code']!=0):
        scan_id=j['scan_id']
        url=j['resource']
        result=j['scans']
        tester=list(result.keys())
        val=list(result.values())
        result=[d['detected']for d in val]
        mal=[d['result']for d in val]

        print("\n\nscan_id: ", scan_id)
        print("URL: ",url)
        print("\n===========Detection===========")
        for i in range(0,65):
            if result[i] == True:
                print (tester[i],result[i], mal[i],"\n")
            i=i+1

for k in range(0,65):
    if result[k] == True:
        doc = {'sitename' : scan_id, 'url' : url, 'tester' : tester[k], 'result' : result[k], 'malware' : mal[k]}
    else:
        doc = {'sitename' : scan_id, 'url' : url, 'tester' : tester[k], 'result' : result[k], 'malware' : mal[k]}
    k=k+1
    es.index(index="vvv", doc_type="virustotal",body=doc)


// 임의 url 사용, result가 True인 것만 출력         
            

        
